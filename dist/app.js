var c=(t,n,a)=>new Promise((e,r)=>{var s=i=>{try{o(a.next(i))}catch(m){r(m)}},d=i=>{try{o(a.throw(i))}catch(m){r(m)}},o=i=>i.done?e(i.value):Promise.resolve(i.value).then(s,d);o((a=a.apply(t,n)).next())});import{DynamoDB as l}from"@aws-sdk/client-dynamodb";import{Rekognition as y}from"@aws-sdk/client-rekognition";import{nanoid as p}from"nanoid";import{PrismaClient as f}from"@prisma/client";var b=new f;function w(a){return c(this,arguments,function*({bucketName:t,objectName:n}){let e=["Person","Knife","Gun","Weapon"];return new y().detectLabels({Image:{S3Object:{Bucket:t,Name:n}},MinConfidence:80,Settings:{GeneralLabels:{LabelInclusionFilters:e}}})})}function g(t){return c(this,null,function*(){return new l({region:"us-east-1"}).putItem({TableName:"livebus-dynamodb",Item:{id:{S:p()},payload:{S:JSON.stringify(t)},insertedAt:{S:new Date().toISOString()}}})})}function u(t,n){return n.Labels.filter(a=>t.includes(a.Name)).length}var k=t=>c(void 0,null,function*(){var n,a;try{yield g(t);let e=(a=(n=t.Records)==null?void 0:n[0])==null?void 0:a.s3;if(!e)throw new Error("No object info");let r=yield w({bucketName:e.bucket.name,objectName:e.object.key}),s=u(["Weapon","Knife","Gun"],r),d=u(["Person"],r),o=yield b.device.findFirst({where:{code:e.bucket.name}});o&&(s>0&&(yield b.alert.create({data:{expiredAt:new Date(Date.now()+15*60*1e3),deviceId:o.id,type:"WEAPON_DETECTION",description:`${s} weapons detected in ${e.object.key}`}})),yield b.telemetry.create({data:{passengerCount:d,deviceId:o.id}}))}catch(e){return{statusCode:500,body:JSON.stringify(e)}}return"Process Finished"});export{k as main};
